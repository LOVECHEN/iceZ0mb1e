                              1 ;--------------------------------------------------------
                              2 ; File Created by SDCC : free open source ANSI-C Compiler
                              3 ; Version 3.8.0 #10562 (Linux)
                              4 ;--------------------------------------------------------
                              5 	.module spi
                              6 	.optsdcc -mz80
                              7 	
                              8 ;--------------------------------------------------------
                              9 ; Public variables in this module
                             10 ;--------------------------------------------------------
                             11 	.globl _spi_config
                             12 	.globl _spi_xfer_single
                             13 	.globl _spi_xfer
                             14 ;--------------------------------------------------------
                             15 ; special function registers
                             16 ;--------------------------------------------------------
                     0018    17 _uart_dm0	=	0x0018
                     0018    18 _uart_thr	=	0x0018
                     0018    19 _uart_rbr	=	0x0018
                     0019    20 _uart_dm1	=	0x0019
                     0019    21 _uart_ier	=	0x0019
                     001A    22 _uart_iir	=	0x001a
                     001B    23 _uart_lcr	=	0x001b
                     001C    24 _uart_mcr	=	0x001c
                     001D    25 _uart_lsr	=	0x001d
                     001E    26 _uart_msr	=	0x001e
                     001F    27 _uart_scr	=	0x001f
                     0040    28 _port_a	=	0x0040
                     0041    29 _port_b	=	0x0041
                     0042    30 _port_cfg	=	0x0042
                     0050    31 _i2c_status	=	0x0050
                     0052    32 _i2c_clkdiv	=	0x0052
                     0053    33 _i2c_cmd	=	0x0053
                     0054    34 _i2c_dat_in	=	0x0054
                     0055    35 _i2c_dat_out	=	0x0055
                     0060    36 _spi_status	=	0x0060
                     0061    37 _spi_cfg	=	0x0061
                     0062    38 _spi_clkdiv	=	0x0062
                     0063    39 _spi_cmd	=	0x0063
                     0064    40 _spi_dat_in	=	0x0064
                     0065    41 _spi_dat_out	=	0x0065
                             42 ;--------------------------------------------------------
                             43 ; ram data
                             44 ;--------------------------------------------------------
                             45 	.area _DATA
                             46 ;--------------------------------------------------------
                             47 ; ram data
                             48 ;--------------------------------------------------------
                             49 	.area _INITIALIZED
                             50 ;--------------------------------------------------------
                             51 ; absolute external ram data
                             52 ;--------------------------------------------------------
                             53 	.area _DABS (ABS)
                             54 ;--------------------------------------------------------
                             55 ; global & static initialisations
                             56 ;--------------------------------------------------------
                             57 	.area _HOME
                             58 	.area _GSINIT
                             59 	.area _GSFINAL
                             60 	.area _GSINIT
                             61 ;--------------------------------------------------------
                             62 ; Home
                             63 ;--------------------------------------------------------
                             64 	.area _HOME
                             65 	.area _HOME
                             66 ;--------------------------------------------------------
                             67 ; code
                             68 ;--------------------------------------------------------
                             69 	.area _CODE
                             70 ;api/spi.c:38: void spi_config(uint8_t mode, uint8_t clock_div)
                             71 ;	---------------------------------
                             72 ; Function spi_config
                             73 ; ---------------------------------
   0000                      74 _spi_config::
                             75 ;api/spi.c:45: spi_cmd = 0x00;
   0000 3E 00         [ 7]   76 	ld	a, #0x00
   0002 D3 63         [11]   77 	out	(_spi_cmd), a
                             78 ;api/spi.c:46: spi_cfg = mode;
   0004 21 02 00      [10]   79 	ld	hl, #2+0
   0007 39            [11]   80 	add	hl, sp
   0008 7E            [ 7]   81 	ld	a, (hl)
   0009 D3 61         [11]   82 	out	(_spi_cfg), a
                             83 ;api/spi.c:47: spi_clkdiv = clock_div/2;
   000B FD 21 03 00   [14]   84 	ld	iy, #3
   000F FD 39         [15]   85 	add	iy, sp
   0011 FD 6E 00      [19]   86 	ld	l, 0 (iy)
   0014 26 00         [ 7]   87 	ld	h, #0x00
   0016 4D            [ 4]   88 	ld	c, l
   0017 5C            [ 4]   89 	ld	e, h
   0018 CB 7C         [ 8]   90 	bit	7, h
   001A 28 03         [12]   91 	jr	Z,00103$
   001C 23            [ 6]   92 	inc	hl
   001D 4D            [ 4]   93 	ld	c, l
   001E 5C            [ 4]   94 	ld	e, h
   001F                      95 00103$:
   001F CB 2B         [ 8]   96 	sra	e
   0021 CB 19         [ 8]   97 	rr	c
   0023 79            [ 4]   98 	ld	a, c
   0024 D3 62         [11]   99 	out	(_spi_clkdiv), a
                            100 ;api/spi.c:48: }
   0026 C9            [10]  101 	ret
                            102 ;api/spi.c:50: uint8_t spi_xfer_single(uint8_t cmd)
                            103 ;	---------------------------------
                            104 ; Function spi_xfer_single
                            105 ; ---------------------------------
   0027                     106 _spi_xfer_single::
                            107 ;api/spi.c:52: spi_dat_out = cmd;
   0027 21 02 00      [10]  108 	ld	hl, #2+0
   002A 39            [11]  109 	add	hl, sp
   002B 7E            [ 7]  110 	ld	a, (hl)
   002C D3 65         [11]  111 	out	(_spi_dat_out), a
                            112 ;api/spi.c:53: spi_cmd = SPI_CMD_FINISH | SPI_CMD_START;
   002E 3E 03         [ 7]  113 	ld	a, #0x03
   0030 D3 63         [11]  114 	out	(_spi_cmd), a
                            115 ;api/spi.c:54: while((spi_status & SPI_STAT_REQ) == 0);
   0032                     116 00101$:
   0032 DB 60         [11]  117 	in	a, (_spi_status)
   0034 0F            [ 4]  118 	rrca
   0035 30 FB         [12]  119 	jr	NC,00101$
                            120 ;api/spi.c:56: return spi_dat_in;
   0037 DB 64         [11]  121 	in	a, (_spi_dat_in)
   0039 6F            [ 4]  122 	ld	l, a
                            123 ;api/spi.c:57: }
   003A C9            [10]  124 	ret
                            125 ;api/spi.c:59: void spi_xfer(uint8_t *tx, uint8_t *rx, uint16_t tx_len, uint16_t rx_len)
                            126 ;	---------------------------------
                            127 ; Function spi_xfer
                            128 ; ---------------------------------
   003B                     129 _spi_xfer::
   003B CDr00r00      [17]  130 	call	___sdcc_enter_ix
   003E F5            [11]  131 	push	af
                            132 ;api/spi.c:62: uint16_t len = rx_len;
   003F DD 4E 0A      [19]  133 	ld	c, 10 (ix)
   0042 DD 46 0B      [19]  134 	ld	b, 11 (ix)
                            135 ;api/spi.c:64: if( tx_len >= rx_len )
   0045 DD 7E 08      [19]  136 	ld	a, 8 (ix)
   0048 91            [ 4]  137 	sub	a, c
   0049 DD 7E 09      [19]  138 	ld	a, 9 (ix)
   004C 98            [ 4]  139 	sbc	a, b
   004D 38 06         [12]  140 	jr	C,00125$
                            141 ;api/spi.c:66: len = tx_len;
   004F DD 4E 08      [19]  142 	ld	c, 8 (ix)
   0052 DD 46 09      [19]  143 	ld	b, 9 (ix)
                            144 ;api/spi.c:69: for(i = 0; i < len; i++)
   0055                     145 00125$:
   0055 79            [ 4]  146 	ld	a, c
   0056 C6 FF         [ 7]  147 	add	a, #0xff
   0058 DD 77 FE      [19]  148 	ld	-2 (ix), a
   005B 78            [ 4]  149 	ld	a, b
   005C CE FF         [ 7]  150 	adc	a, #0xff
   005E DD 77 FF      [19]  151 	ld	-1 (ix), a
   0061 11 00 00      [10]  152 	ld	de, #0x0000
   0064                     153 00110$:
   0064 7B            [ 4]  154 	ld	a, e
   0065 91            [ 4]  155 	sub	a, c
   0066 7A            [ 4]  156 	ld	a, d
   0067 98            [ 4]  157 	sbc	a, b
   0068 30 4D         [12]  158 	jr	NC,00112$
                            159 ;api/spi.c:71: spi_dat_out = (i < tx_len) ? tx[i] : 0x00;
   006A 7B            [ 4]  160 	ld	a, e
   006B DD 96 08      [19]  161 	sub	a, 8 (ix)
   006E 7A            [ 4]  162 	ld	a, d
   006F DD 9E 09      [19]  163 	sbc	a, 9 (ix)
   0072 30 0A         [12]  164 	jr	NC,00114$
   0074 DD 6E 04      [19]  165 	ld	l, 4 (ix)
   0077 DD 66 05      [19]  166 	ld	h, 5 (ix)
   007A 19            [11]  167 	add	hl, de
   007B 6E            [ 7]  168 	ld	l, (hl)
   007C 18 03         [12]  169 	jr	00115$
   007E                     170 00114$:
   007E 21 00 00      [10]  171 	ld	hl, #0x0000
   0081                     172 00115$:
   0081 7D            [ 4]  173 	ld	a, l
   0082 D3 65         [11]  174 	out	(_spi_dat_out), a
                            175 ;api/spi.c:72: spi_cmd = (i == (len-1)) ? SPI_CMD_FINISH | SPI_CMD_START : SPI_CMD_START;
   0084 DD 7E FE      [19]  176 	ld	a, -2 (ix)
   0087 93            [ 4]  177 	sub	a, e
   0088 20 0B         [12]  178 	jr	NZ,00116$
   008A DD 7E FF      [19]  179 	ld	a, -1 (ix)
   008D 92            [ 4]  180 	sub	a, d
   008E 20 05         [12]  181 	jr	NZ,00116$
   0090 21 03 00      [10]  182 	ld	hl, #0x0003
   0093 18 03         [12]  183 	jr	00117$
   0095                     184 00116$:
   0095 21 01 00      [10]  185 	ld	hl, #0x0001
   0098                     186 00117$:
   0098 7D            [ 4]  187 	ld	a, l
   0099 D3 63         [11]  188 	out	(_spi_cmd), a
                            189 ;api/spi.c:73: while((spi_status & SPI_STAT_REQ) == 0);
   009B                     190 00103$:
   009B DB 60         [11]  191 	in	a, (_spi_status)
   009D 0F            [ 4]  192 	rrca
   009E 30 FB         [12]  193 	jr	NC,00103$
                            194 ;api/spi.c:75: if(i < rx_len)
   00A0 7B            [ 4]  195 	ld	a, e
   00A1 DD 96 0A      [19]  196 	sub	a, 10 (ix)
   00A4 7A            [ 4]  197 	ld	a, d
   00A5 DD 9E 0B      [19]  198 	sbc	a, 11 (ix)
   00A8 30 0A         [12]  199 	jr	NC,00111$
                            200 ;api/spi.c:77: rx[i] = spi_dat_in;
   00AA DD 6E 06      [19]  201 	ld	l, 6 (ix)
   00AD DD 66 07      [19]  202 	ld	h, 7 (ix)
   00B0 19            [11]  203 	add	hl, de
   00B1 DB 64         [11]  204 	in	a, (_spi_dat_in)
   00B3 77            [ 7]  205 	ld	(hl), a
   00B4                     206 00111$:
                            207 ;api/spi.c:69: for(i = 0; i < len; i++)
   00B4 13            [ 6]  208 	inc	de
   00B5 18 AD         [12]  209 	jr	00110$
   00B7                     210 00112$:
                            211 ;api/spi.c:80: }
   00B7 F1            [10]  212 	pop	af
   00B8 DD E1         [14]  213 	pop	ix
   00BA C9            [10]  214 	ret
                            215 	.area _CODE
                            216 	.area _INITIALIZER
                            217 	.area _CABS (ABS)
